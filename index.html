<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EENADU AI JOURNALIST POC</title>
    <style>
        body {
            background-color: #121212;
            color: #FFFFFF;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        #logo {
            width: 100px;
        }
        .button {
            background-color: #0B5F59;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        .button:disabled {
            background-color: grey;
        }
        .response {
            background-color: #2B2B2B;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: left;
        }
        #record-speech-div {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <img id="logo" src="logo.png" alt="EENADU Logo">
        <h1>EENADU AI JOURNALIST POC</h1>
        <p>Current Session ID: <span id="sessionIdDisplay">Not started</span></p>
        <button id="generateSessionBtn" class="button">Generate New Session ID</button>

        <div id="sessionControls" style="display:none;">
            <button id="startSessionBtn" class="button">Start Session</button>
        </div>

        <div id="actions" style="display:none;">
            <h3>Choose an Action</h3>
            <select id="actionSelector" class="button">
                <option value="uploadAudio">Upload Audio</option>
                <option value="recordAudio">Record Audio</option>
            </select>

            <!-- File Upload Section -->
            <div id="uploadAudioSection">
                <input type="file" id="audioFileInput" accept=".wav,.mp3">
                <input type="text" id="languageCode" placeholder="Enter Language Code" value="te-IN">
                <button id="submitBtn" class="button">Submit</button>
            </div>

            <!-- Speech Recording Section -->
            <div id="record-speech-div">
                <button id="recordBtn" class="button">Start Recording</button>
                <span id="record-status">Not Recording</span>
                <br>
                <button id="stopBtn" class="button" disabled>Stop Recording</button>
            </div>

            <div id="endSessionSection" style="margin-top: 20px;">
                <button id="endSessionBtn" class="button">End Session</button>
            </div>
        </div>

        <div id="responses">
            <h3>Responses:</h3>
            <div id="responseLog"></div>
        </div>

        <div id="spokenTextSection" style="margin-top: 20px;">
            <h3>Spoken Text:</h3>
            <div id="spokenTextDisplay" class="response">Text will appear here.</div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let recognition;
        let uploadedText = '';  // Store the uploaded transcribed text
        let spokenText = '';

        function logResponse(message) {
            const responseLog = document.getElementById("responseLog");
            const responseEntry = document.createElement("div");
            responseEntry.className = "response";
            responseEntry.textContent = message;
            responseLog.appendChild(responseEntry);
        }

        function displayText(text) {
            const spokenTextDisplay = document.getElementById("spokenTextDisplay");
            spokenTextDisplay.textContent = text;
            spokenText = text;  // Update spoken text
        }

        document.getElementById("generateSessionBtn").addEventListener("click", function() {
            sessionId = 'c02326e6-27c4-4865-ae91-b107571697a5'; // Mock session ID
            document.getElementById("sessionIdDisplay").textContent = sessionId;
            document.getElementById("sessionControls").style.display = "block";
            logResponse("Generated new session ID: " + sessionId);
        });

        document.getElementById("startSessionBtn").addEventListener("click", function() {
            fetch("https://eenadu-backend.onrender.com/start-session/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ session_id: sessionId })
            })
            .then(response => response.json())
            .then(data => {
                logResponse("Session started: " + JSON.stringify(data));
                document.getElementById("actions").style.display = "block";
            })
            .catch(error => logResponse("Failed to start session: " + error));
        });

        document.getElementById("actionSelector").addEventListener("change", function() {
            const action = this.value;
            if (action === "uploadAudio") {
                document.getElementById("uploadAudioSection").style.display = "block";
                document.getElementById("record-speech-div").style.display = "none";
            } else {
                document.getElementById("uploadAudioSection").style.display = "none";
                document.getElementById("record-speech-div").style.display = "block";
            }
        });

        document.getElementById("submitBtn").addEventListener("click", function() {
            const fileInput = document.getElementById("audioFileInput");
            const languageCode = document.getElementById("languageCode").value;

            if (fileInput.files.length === 0) {
                logResponse("No audio file selected.");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("language", languageCode);
            formData.append("session_id", sessionId);

            fetch("https://eenadu-backend.onrender.com/upload-audio/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                uploadedText = data.transcribed_text || ''; // Store the uploaded transcribed text
                logResponse("Audio uploaded: " + JSON.stringify(data));
            })
            .catch(error => logResponse("Failed to upload audio: " + error));
        });

        // Initialize speech recognition
        if (window.SpeechRecognition || window.webkitSpeechRecognition) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'te-IN'; // Telugu language
            recognition.interimResults = false;
            recognition.continuous = true;

            recognition.onresult = function(event) {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                displayText(transcript);
            };

            recognition.onerror = function(event) {
                logResponse("Speech recognition error: " + event.error);
            };
        } else {
            logResponse("Speech Recognition API is not supported in this browser.");
        }

        document.getElementById("recordBtn").addEventListener("click", function() {
            if (recognition) {
                recognition.start();
                document.getElementById("record-status").textContent = "Recording...";
                document.getElementById("recordBtn").disabled = true;
                document.getElementById("stopBtn").disabled = false;
            } else {
                logResponse("Speech recognition is not available.");
            }
        });

        document.getElementById("stopBtn").addEventListener("click", function() {
            if (recognition) {
                recognition.stop();
                document.getElementById("record-status").textContent = "Recording stopped";
                document.getElementById("recordBtn").disabled = false;
                document.getElementById("stopBtn").disabled = true;
            }
        });

        document.getElementById("endSessionBtn").addEventListener("click", function() {
            const compiledSpeechToText = uploadedText + ' ' + spokenText; // Merge both texts
            fetch("https://eenadu-backend.onrender.com/end-session/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ session_id: sessionId, compiled_speech_to_text: compiledSpeechToText })
            })
            .then(response => response.json())
            .then(data => logResponse("Session ended: " + JSON.stringify(data)))
            .catch(error => logResponse("Failed to end session: " + error));
        });
    </script>
</body>
</html>
